# Prometheus Queries - Actividad 22
# Fecha: Diciembre 2025

## Queries Básicas

# Estado de todos los targets
up

# Estado del OpenTelemetry Collector específicamente
up{job="otel-collector"}

## Exploración de Métricas

# Ver todas las métricas que empiezan con "http"
{__name__=~"http.*"}

# Ver todas las métricas del job otel-collector
{job="otel-collector"}

## Métricas del OTEL Collector (internas)

# Spans recibidos por el collector
otelcol_receiver_accepted_spans

# Spans enviados a exportadores
otelcol_exporter_sent_spans

# Métricas recibidas
otelcol_receiver_accepted_metric_points

# Errores en el receiver
otelcol_receiver_refused_spans

## Métricas HTTP (si están disponibles)

# Total de requests (counter derivado de histogram)
http_server_duration_seconds_count

# Histogram de latencias
http_server_duration_seconds_bucket

# Suma de duraciones
http_server_duration_seconds_sum

## Queries de Agregación

# RPS total (si existe la métrica)
sum(rate(http_server_duration_seconds_count[5m]))

# RPS por endpoint
sum by (http_route) (rate(http_server_duration_seconds_count[5m]))

# Error rate 5xx (si existe la métrica con ese label)
sum(rate(http_server_duration_seconds_count{http_status_code=~"5.."}[5m]))
/
sum(rate(http_server_duration_seconds_count[5m]))

## Queries de Debugging

# Ver labels disponibles para una métrica
http_server_duration_seconds_count

# Contar series temporales
count({__name__=~"http.*"})

# Ver todos los valores de un label
count by (http_route) (http_server_duration_seconds_count)

## Queries para Alertas

# Target down
up{job="otel-collector"} == 0

# Alta latencia (p95)
histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket[5m])) by (le)) > 1

## Notas sobre este Stack

# En este stack particular, las métricas HTTP pueden no estar disponibles
# porque la app solo configura el exporter de trazas, no de métricas.
# 
# La query `http_server_requests_total` que usa el MCP Server devuelve 0
# porque esa métrica no existe con ese nombre.
#
# Para tener métricas HTTP, se necesitaría agregar:
# - opentelemetry-sdk-metrics
# - OTLPMetricExporter
# - Configurar el meter provider en la app
